## Общий Интерфейс Klumba Bot v. [2.0.1] - 2022-02-25
### Fixed / Исправлено
- Согласование заказов: клиент больше не будет получать фиктивную ошибку, если согласовал заказ
- Курьеры: отображение списка заказов теперь работает корректно, если поле **Кто отправил заказ** не заполнено


## Общий Интерфейс Klumba Bot v. [2.0.0] - 2022-02-23
### Added / Добавлено
- Механизм авторизации изменен - теперь войти можно с помощью номера телефона, привязанного к аккаунту в Telegram, 
который должен совпадать с полем **Телефон (основной)** в аккаунте Б24.
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/35207/)
- Бот курьера интегрирован с ботом оператора, доступ к разным частям определяется полем "Должность (нов)".
Для курьеров доступны отдельные группы заказов: в доставке сегодня, завтра, назначенные заранее,
завершенные (вовремя и опоздавшие) - c доступом к разным датам через календарь
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27709/)
- Создание учетных записей курьеров автоматизировано на основе статического приложения в B24 - https://klumba.bitrix24.ru/marketplace/app/131/
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/34299/)
- При укомплектовании заказа теперь требуется загрузить фото лицевой и оборотной стороны открытки отдельно.
При этом для согласования клиенту эти фотографии больше не отправляются
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27703/)
- Изменен механизм назначения курьеров и флористов: теперь можно выбрать - 
посмотреть весь список курьеров/флористов или ввести начало фамилии 
и отфильтровать варианты для выбора таким образом. Также введено разделение списка на страницы.
Если курьер (флорист) уже назначен - явно указывается назначенный, а список выводится по нажатию кнопки **Изменить** (уже назначенный больше не исключается из списка)
Можно оставить назначенного отдельной кнопкой.
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27705/)
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/34303/)
- Последовательность выбора при резерве товара переработана - теперь для каждого заказа сразу предлагаются 3 варианта:
**Отложить товар сейчас**, **Ждет поставки**, **Резерв не нужен**. Теперь они собраны в общей группе **Обработать заказ**
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/34245/)
- Во всех возможных случаях взаимодействие с ботом изменено с /-команд на кнопки
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/34241)
- Для каждой из основных команд оператора введены ограничения стартовых стадий - так, обработать заказ можно только со стадии **Оплачен**, 
Отправить заказ(Назначить курьера) - только из **Согласовано**,
Назначить флориста - из **Оплачен (Предоплачен), Обработан, но ждет поставки, или Обработан, тов. отложен**
Укомплектовать - **Выбит в 1С или Несогласовано, или У Флориста, или с себя самой**
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27707/)
- После обработки команды, в заказе автоматически проставляется сотрудник, выполнивший ее
  **(Кто укомплектовал, Кто отправил заказ, Кто обработал...)**
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27705/)
- Для курьеров при просмотре заказов обновлен список отображаемых полей и их представление
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27687/)
- Переработана загрузка чек-листов - теперь команда называется **Отправить заказ (назначить курьера)**,
поля **К оплате, Терминал\Сдача, Сдача с** отображаются если значение **Тип оплаты** соответствующее, если оплачено не 100% заказа - дополнительно фиксируется обеспечен ли курьер
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27685/)
- Для курьеров добавлена возможность вернуть заказ на склад. При этом фиксируется причина возврата, а заказ возвращается к стадии **Согласован**
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27681/)

### Fixed / Исправлено
- Если поле **Текст открытки** (**Есть открытка**) не заполнено, то при просмотре информации о заказе 
в любом контексте оно больше не отображается
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/35209/)


### Technical / Технические
- Ведение логов изменений для каждой версии (патчноуты)
- Введена политика версионирования вида MAJOR.MINOR.PATCH, где
    - MAJOR (2) - глобальные изменения, с возможным нарушением обратной совместимости
    - MINOR (0) - значимый новый функционал или крупный багфиксинг
    - PATCH (0) - мелкие патчи или новая функциональность
    - Руководствуемся https://semver.org/ при версионировании по возможности
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/35855/)
- Для случая превышения лимита запросов в 2/сек для одной точки доступа к B24 API 
введен контроль ответа QUERY_LIMIT_EXCEEDED с временной приостановкой дальнейшей обработки - как временное решение 
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27709/)
- Архитектура бота курьера значительно переработана с использованием PTB
- Оптимизированы многостраничные запросы к B24, улучшена обработка и логирование ошибок
- Рефакторинг воркеров обработки команд B24 и отправки сообщений в Telegram
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27709/)
- Исправления багов при загрузке справочников
(https://klumba.bitrix24.ru/workgroups/group/119/tasks/task/view/27709/)